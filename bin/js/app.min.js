var app = angular.module("app", ["ui.router", "ui.bootstrap-slider", "ngAnimate"]);

app.config(function($stateProvider, $urlRouterProvider, $locationProvider) {
	$urlRouterProvider.otherwise("/");

	$stateProvider
		.state("select-model", {
			url: "/",
			template: "<select-model></select-model>"
		})
		.state("customize", {
			url: "/personalizacja",
			template: "<customize></customize>",
			params: { model: null }
		})
		.state("order-options", {
			url: "/opcje",
			template: "<order-options></order-options>"
		})
		.state("order-form", {
			url: "/zamowienie",
			template: "<order-form></order-form>"
		})
		.state("summary", {
			url: "/podsumowanie",
			template: "<summary></summary>"
		})
		.state("confirmation", {
			url: "/potwierdzenie",
			template: "<confirmation></confirmation>",
			params: {
				submitModel: null,
				previewId: null,
				prices: {}
			}
		})
		.state("preview", {
			url: "/preview/{id}",
			template: "<preview></preview>"
		})
});

app.directive("app", function() {
	return {
		restrict: "E",
		scope: {},
		templateUrl: "app.html",
		controllerAs: "vm",
		controller: "appController"
	}
});

app.controller("appController", ["$state", function($state) {
	this.$state = $state;
}]);

app.factory("appService", ["$rootScope", "$q", function($rootScope, $q) {
	var model = null;
	var images = {};
	var showWarning = new Rx.ReplaySubject(1);

	$rootScope.$on("decal-image-added", function(event, image) {
		images[image.id] = image;
	});

	$rootScope.$on("decal-image-removed", function(event, image) {
		delete images[image.id];
	});

	return {
		getModels() {
			/*var req = {
				method: 'POST',
				url: 'http://dev.lithium.pl/perfecta/wp/wp-admin/admin-ajax.php',
				data: $.param({ action: "getModels" }),
				headers: {'Content-Type': 'application/x-www-form-urlencoded'}
			}

			return $http(req);*/

			// Mock ↓ (TODO: Na produkcji modele mają być pobieranie z WP)
			return $q(function(resolve, reject) {
				resolve({ data: mock_initModels() });
			});
		},
		getModel() { return model; },
		getImages() { return images; },
		setModel(newModel) {
			model = newModel;
			images = {};
			showWarning = new Rx.ReplaySubject(1);
			$rootScope.$broadcast("model-selected", model);
		},
		orderForm: new Rx.ReplaySubject(1),
		orderOptions: new Rx.ReplaySubject(1),
		showWarning: function() { return showWarning; }
	}
}]);

// Mock ↓ (TODO: Usunąć na produkcji)
function mock_initModels() {
	var models = [];

	var modelTemplate = {
		model3d: {
			top: "",
			bot: "",
			tiles: 0
		},
		title: "Parasol",
		subtitle: "3M/8",
		shape: "suqare",
		price: {
			base: [1234, 2345],
			delivery: [200, 500],
			print: [0.3, 0.25]
		},
		bases: [
			{
				name: "Podstawa B",
				url: "podstawa_B.svg",
				price: 123
			},
			{
				name: "Podstawa G",
				url: "podstawa_G.svg",
				price: 234
			},
			{
				name: "Podstawa H",
				url: "podstawa_H.svg",
				price: 345
			}
		],
		legend: {
			imageUrl: "img/mock/legenda-1.svg",
			params: {
				H1: "283 cm",
				H2: "203 cm",
				H3: "73 cm",
				H4: "213 cm"
			}
		},
		params: {
			weight: "ok. 12.6 kg",
			material: "Lorem Ipsum"
		},
		info: {
			frame: "Aluminium malowane proszkowo w kolorze białym",
			openingImgUrl: "img/mock/otwieranie_dzwignia-1.svg",
			mechanismImgUrl: "img/mock/teleskop_bez-teleskopu.svg",
			topImgUrl: "img/mock/szyt_bez-daszka.svg",
			frillImgUrl: "img/mock/falbany_zfalbana.svg",
			fieldsImgUrl: "img/mock/pola_ogragly8.svg",
			basisImgUrl: "img/mock/podstawa_K.svg"
		}
	};

	var modelsFiles = [
		["2m california", 4, "square"],
		["3,5x3,5", 4, "square"],
		["3x3", 4, "square"],
		["3x3 floryda", 4, "square"],
		["3x3 okragly", 8, "round"],
		["3x3 okragly bez wolantu", 8, "round"],
		["4m floryda", 8, "round"],
		["4x4", 4, "square"],
		["4x8 okragly", 8, "round"],
		["4x8 okragly bez wolantu", 8, "round"],
		["5x5", 4, "square"],
		["5x8 okragly", 8, "round"],
		["5x8 okragly bez wolantu", 8, "round"],
		["7x7", 4, "square"]
	];

	modelsFiles.forEach(file => {
		var model = $.extend(true, {}, modelTemplate);
		model.model3d.top = "models/converted/" + file[0] + " (top).json";
		model.model3d.bot = "models/converted/" + file[0] + " (bot).json";
		model.tiles = file[1];
		model.subtitle = file[0];
		model.shape = file[2];
		models.push(model);
	})

	return models;
}
app.directive("confirmation", function() {
	return {
		restrict: "E",
		scope: {},
		templateUrl: "confirmation/confirmation.html",
		controllerAs: "vm",
		controller: "confirmationController"
	}
});

app.controller("confirmationController", ["$rootScope","$scope", "$state", "$stateParams", "appService", "priceService", function($rootScope, $scope, $state, $stateParams, appService, priceService) {
	if (!(this.model = $stateParams.submitModel)) {
		$state.go("summary");
	}

	var vm = this;
	vm.previewId = $stateParams.previewId;

	appService.setModel(null);

	vm.previewTest = function() {
		$state.go("preview", { id: vm.previewId });
	}

	vm.savePdf = function() {
		var data = $stateParams.submitModel;
		var id = $stateParams.previewId;
		var prices = $stateParams.prices;

		var logoPerfectaBase64 = "data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/4QBaRXhpZgAATU0AKgAAAAgABQMBAAUAAAABAAAASgMDAAEAAAABAAAAAFEQAAEAAAABAQAAAFERAAQAAAABAAAOxFESAAQAAAABAAAOxAAAAAAAAYagAACxj//bAEMAAgEBAgEBAgICAgICAgIDBQMDAwMDBgQEAwUHBgcHBwYHBwgJCwkICAoIBwcKDQoKCwwMDAwHCQ4PDQwOCwwMDP/bAEMBAgICAwMDBgMDBgwIBwgMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDAwMDP/AABEIADIApAMBIgACEQEDEQH/xAAfAAABBQEBAQEBAQAAAAAAAAAAAQIDBAUGBwgJCgv/xAC1EAACAQMDAgQDBQUEBAAAAX0BAgMABBEFEiExQQYTUWEHInEUMoGRoQgjQrHBFVLR8CQzYnKCCQoWFxgZGiUmJygpKjQ1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4eLj5OXm5+jp6vHy8/T19vf4+fr/xAAfAQADAQEBAQEBAQEBAAAAAAAAAQIDBAUGBwgJCgv/xAC1EQACAQIEBAMEBwUEBAABAncAAQIDEQQFITEGEkFRB2FxEyIygQgUQpGhscEJIzNS8BVictEKFiQ04SXxFxgZGiYnKCkqNTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqCg4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2dri4+Tl5ufo6ery8/T19vf4+fr/2gAMAwEAAhEDEQA/AP0B/a//AGu7/wCN2uePre38f618I/2dfhDqEug+MfGHh6ZI/EvjbXI4y1xo2kz/ADfYbSzBzeX+EkV4plWS2jtbm4CfsnfsX/sSftWXPiS30/4J+FNc8WeH5Y21xPGYi8Uawhm3NHJJqMlzei43bW5W5kKEbXCNxWZ+zF+xSv7bP/BCf4P+Hf7dk0nxB4q8MTeJ5tTmiNwtxea9ZX6at5q5B/0iHWdRUOCTE8yShX8vY3vv7D/7D99+zf408VeKdcutNS+8Qz3Eljo2nTve2+hrczLNdA30sUVxeNK8VuFM6Zt4baC3jPlxjIBD/wAOZf2S/wDo2/4L/wDhJWf/AMbo/wCHMv7Jf/Rt/wAF/wDwkrP/AON19MUUAfM//DmX9kv/AKNv+C//AISVn/8AG6P+HMv7Jf8A0bf8F/8AwkrP/wCN19MUUAfM/wDw5l/ZL/6Nv+C//hJWf/xuj/hzL+yX/wBG3/Bf/wAJKz/+N19MUUAfM/8Aw5l/ZL/6Nv8Agv8A+ElZ/wDxuj/hzL+yX/0bf8F//CSs/wD43X0xX4gf8HLf/BaL4wfCr9qHwp+yv+zlq11onjDXIrM67qek7f7YnvL5/LstKtnYf6OxVopWkQ+Y3nwBXjCyCQA/Sf8A4cy/sl/9G3/Bf/wkrP8A+N0f8OZf2S/+jb/gv/4SVn/8br5b/wCCWv8AwRt/ah/Zb/aH8KfET43ftifEP4nWOkWVyb3wUfEGr3+k3F1NA8K75Lq52zxxeYZBut1O9EOBiv08oA+Z/wDhzL+yX/0bf8F//CSs/wD43R/w5l/ZL/6Nv+C//hJWf/xuvpiigD5n/wCHMv7Jf/Rt/wAF/wDwkrP/AON0f8OZf2S/+jb/AIL/APhJWf8A8br6Yryf9uz9pW3/AGOv2M/ih8Ubhrbd4G8NX2rWsdw22O5uo4W+zwE/9NZzHGPdxQB5/wD8OZf2S/8Ao2/4L/8AhJWf/wAbo/4cy/sl/wDRt/wX/wDCSs//AI3X5lf8Ge3j343/ALUXib4wfEz4n/Fr4teOvDeg2tp4Z0ey8R+Kb7VdPku5m+03MqxzyuomhjhtlDAZC3bjOGOf3NoA+Zz/AMEZP2SyP+TcPgx/4Sdn/wDG65/xR/wS3tfgRpM2ufsueI774K+MtPzcWmhvf3d94E11gUP2W/0d5GihikCbPtFiILiLzCyu4Bjb64ooA8n/AGMv2pof2tvg1/btxodx4R8V6HqNx4e8XeGLm7jurjwxrVqwS6s3lj+WVQSskUoAE0E0EoVRIACvwf8A+Dl79un4ofsAf8FR9Y0r4YeKdR8O6f4+8PaZ4r1eGCd0We/8ttO83AYDP2fTrVf+AUUAftF/wRn/AOUTP7N//ZOdE/8ASKKsH/guh+1rcfsVf8EpvjJ4202+uNP8QPop0PRLi1ufs91b31+62cU8LghhJD5xnBU5AgJHSt7/AIIz/wDKJn9m/wD7Jzon/pFFX5a/8HuH7VH9mfDf4M/BWyuIWk1i/uvGWrRBiJYkt0NpZ5HdJGuL08/xW6/gAeM/8Ebv+Cav7Vn/AAVk/ZTvvipcfttfG/4a6emv3Gi6faSalq2qHUY4IoWe5WT+0YQq+ZI8WNp+aF+elcH+0z+1V+2D/wAG5P8AwUg0Hw74s+PHi/42eEryztdc+ya3rF1e2XiLSZJ5IpYzBdSTfYrndBKoeJiy4RtzKxQ/pt8B/wDgpL+zj/wQA/YK+C/wN+KPii+sfiJo/guDWtW8N6Vp8upX1vfXmby5jkKARxM1zPMEWV0JQKThSCfz3+GfwM+IH/B0/wD8FeYfjNrHg7VvCn7NvguW101rnUk+WbS7OR5V0yORcLNd3MskryiNmFstycs22ISgH2v/AMF9/wDgv740/Ze+Mnh39m/9mizi1T43eKmskvtUa0jvZNEe92fYrG1tpAUkvZxJE5MylI45YwEkaXdB8nftGfsi/tLfs4fDDxBrnjj/AIKlaR4f+PXh+w/tm5+GF38UJNPzIYxcJaK0l/GokkjK7ENosTs6jcIz5leLftf/ABMvP+CVX/B0lrfxZ+NHh3Xtf8Np4nvPE9i1vCjzXel31pPBZXNp52I5WtDIoAyFEtiyblK5HsXiTxF/wRt+Kvim817X9c+MGveJfEFw15f3eozeI7u/v7mVtzvLIQxklZiSW3HJPU0Ae0f8E6v+DiD4gfGj/gib+1D4u+JOoLcfE34FaNDaaf4mtbVLd9Rl1cTWulSSxxgJ50V4hDMiopTyyRuDu3xt/wAE5/2Yf2sv+CgP/BPz4zfHyH9rz43eF9O+FiX0enaSuvavqU3iS5s7AXksCsl6jRE+ZbxqVjlLNKcLlNrevf8AByj+y98Gf+CR/wCxF4Q+CPwT0LUPD0vxu8UDxR4je41Wa8nuLTSbcxQQS+axYRme+EiDpvhc1+uX/BAb9lr/AIZE/wCCR3wX8NzQrFq2saIvifVCY/LkNxqTG82SD+/FHNHCfaEUAfnD/wAEPdC/bE/4KN/8E9/2g/hP8QPjB8VvhncQ6loH/CMeOPEFnfXGu6epmnuNQgt7h57e5dWW3tEO6YqiTyKBhyB+a3/BMX9hbx7/AMFe/wDgqPrmi6N8cPFVrrXhmG58Tr8T75Li81lorCaC3srtQ10syzMzWgXFxuiUZDN5YB/pa/4LoftRt+x//wAEnvjZ4wt7hrbVpvD8mg6U8cojmS81BlsYpI+eWiM/nYHOISegNfnh/wAGTX7LY8Lfs3fFz4xXkK/avGGuQeGdOMkWHjtrGLzpnRscpLLeKpwfvWntQBxv7Y/7ZnxE/wCDbX4Pap8JNN+OHi79pL9o/wCMEsWpWms+KBeXFr4G0hFaCBorS4urlZLqWc3JQBtrFAZUZY40m53xz+xT+1VpHghfEHx0/wCCn2k/Ar40+IdMXX7P4faz8RZNEhhWYN5aTGO8gjt13o8bG3tZYlaNwpcLXj//AAcCR63+xN/wcj+GPjh4+8N6prPw7uNY8MeLNFWNi0epWemRWMV3bwsxEYmS4t5WMJYD99EzgLMCfU/i58dv+CQf7V/xI1f4jfEXxB8YtX8beL5/7Q1a41Z9dku/NIAEbeUGiVY1CxqkR8tERUTCqoAB7r/wbgf8F9PF/wAffhr8X/C/7RviWHVP+FMeG28XL4veBGmbSrc+XdJcGAYneP8AdMjorSS73yXYAn551j/gqV+1V/wXL+KvxC1X4e/FQfsp/szfDMQy6pr0Vw9re2scsjJbCWe2/wBKub+fDEW1u6QgIqkl9ry/WH7W/wDwRI+FHwm/4IpfHPVf2TfBXiZfEXxc8I6LrEcV5d3dxqd9plte22pvbxwznzY5Ht1kzAF3yOqR7S2BX5a/8Erv24fgBpP/AATk8Yfs9/GXxl4k+Fd7cfEBPHmn+JtP8Pya3bakn2CKzNjNDCRKNmx5FJIXLg5BUh8cRKpGlJ0VeVtF5ns8PYfLq+Z0KOb1XSw8pJVJpOTjG+rSSbbtto+9nsfVnwO/YX8UftLfFLTPBvg7/grJ8YtX8Ta0ZBaWkmj+KLT7QURpGAkn1BE3bEYgFgTjAyav/wDB4z4A8X/Ba2+Huox/HDxf/wAIf40sIfCtl8NEkuxY3drpgFxNqV5M10yXdwLie1GZIN5/dEuTECfq/wD4IF/sX/Af4i+Lbv48fDH4pa78VrPwffXGgWUtz4Xm8PwWN+1qhmJSZmeZhb3SAYwq+aT8xxt/OH/g8y+KmteKf+Cn3hPwtqUN/a+HvCfgm0k01H4jumubm4e4uYs8fMY0hJ6Ztcdq58vnipU74uKjK+y7fe/PqfQ+IOD4VwuZqjwhXqV8PyK86qs3O7ukuSm+VLl3je991Y90/wCCVH/Bt/8AHHxz+xV8OfHGifthfEb4M6H8R7SHxbc+EfDUF7DCkd0qGOXzYdRiRpprRLdi5hyuVU7ggJ+yf+C1HwP8RfG/4y6PZXf/AAUM8G/sn+GNDtVGm+GI9SXR9QvHZF8y5urg6pbSXBJGEXaERAMAszu0Hxq/4LleAfi3/wAEc/jp4s/ZBbXbnXvgz4W0qyjt5dAuLVvDEN5KtosqBlKO1pbJcTZQvGn2YMxKdfxL/wCCT+ofsO+NLbx54i/bU8RfEjUvG2o6mJtPWH7dNa3scg3y3Us9runkummL7vNIXBUjezNs7j4U+g/25vh78QP2HPgFefEr4c/8FXYPjNr3h+7tf+KX0j4iTNqV6kkyRFoYY9TuvO2Fw7o6BfLWQknAVv2g/wCDfD/goF45/wCCkn/BNvQfHvxHtYf+Ew03VLvw/falBbrbQ68bfyyt6sSgJGzLIEcRgJ5kUhVUUhF/nK/4LHaj+w3HongKz/Y80/XpLySe9m8U3+qS6oDDGqwrawxpeHB3Fp2ZlGR5aDPzEV/T1/wRx/ZX/wCGL/8AgmH8Fvh7NbzWmp6b4bgv9WhlH7yHUb0te3aH12XFxKg/2VA4xigD8Av+DzH/AJSz6D/2TrTP/S3UKKP+DzH/AJSz6D/2TrTP/S3UKKAP37/4IvXcd5/wSX/ZzMbK3k/D/SIHx/BJHaojqfQqyspHYgivx3/4KCfsS/Gf/gqJ/wAHL2gtrvwj+JS/BLw3r+l6ANd1XwrfWuhyaLpq/ar5RePGIWjuJ/twicNhzcRhdxYZ/Uz4KfFSy/4JdfGjVPg78RpIfDvwi8ceIb7WvhX4yuGSHR7Wa/nlvbrwzey7VS0uYrmS5kszK2y5t5FiRzNbsjfa1AH5z/taat8JfBv7T/ipbj/gnzefFbVo7tLi58Z2vwutb4azcSRpI8ouXtGeUqzFC5Y5KHBxiuo0f/grb4w8PaVbWGn/ALG37QljY2cSwW9vb+GZoooI1GFRFWEBVAAAAGABX3hRXnywuJcm1WaXbljp+B97hOI+HKdCFOtlEZySScnXrJyaWsrJpK71slZX0Pzl+NH7fUP7SGhW+l/ET9gX4t+PdNs5DNBaeIvAg1SCByMF1Se2dVbHGQM15xo/jT4O+HtXtdQ0/wD4Ja6xY31jMlxbXEHwiso5beRGDI6MLMFWVgCCOQRX6w0VP1TFf8/3/wCAx/yOj/Wjhj/oSx/8H1//AJI/Mz43ftZ+GP2mNftNV+JH/BOn4h/EDVLC3+yW154k+HEWqz20O4v5aPPauypuZm2ggZJPevSbb/gr543s7eOGH9j39oqKGJQiInhydVRRwAAIcAAdq+6qKPqmK/5/v/wGP+Qf60cMf9CWP/g+v/8AJH51/GX/AIKFt+0Z4RTw/wDEL9g34xeOtBjuEvF03xD4I/tO0WZAwWURTW7JvUMwDYyAx9atfCj/AIKS33wH8D2vhjwP+wx8a/BvhuxaR7bSdD8GNp9jbtI5dykMNuqKWdmY4AyWJPJr9CqKPqmK/wCf7/8AAY/5B/rRwx/0JY/+D6//AMkfnl8Wf+Cjl18fPCD+H/HX7Cnxn8aaDJKsz6br3go6lZtIudrmKa3ZCwycHGRk15Edd+CR/wCcVeof+Gesf/kKv1qoo+qYr/n+/wDwGP8AkH+tHDH/AEJY/wDg+v8A/JHwrB/wV+8cWsCRx/se/tFRxxqFRF8OzhVA4AA8ngCvG/iH8Z/hp8XPF194g8Vf8EyfFHibXtTlM95qWq/Cq1vLy7kPV5JZLMu7H1Yk1+p1FH1TFf8AP9/+Ax/yD/Wjhj/oSx/8H1//AJI/O34N/wDBQ6T9nTwd/wAI78P/ANg/4yeBfD/nvdf2Z4f8E/2bZ+a+N8nlQ26pvbaMtjJwPSs/43/tx6d+01Z2Fv8AEj/gn58U/iDb6UzvZReJfACaslmz4DmMT2zhC21clcZ2jPSv0ioo+qYr/n+//AY/5B/rRwx/0JY/+D6//wAkfm98Ff25NP8A2bdG1HTfh3/wT9+KngHT9YkE1/a+HPAC6XDeuF2hpUgtkDkLxlgTjivPL7xX8GdTvJbi4/4JY6pPcTMXkkf4QWTM7HqSfsXJPrX6yUUfVMV/z/f/AIDH/IP9aOGP+hLH/wAH1/8A5I/Mb4AeBvgX8cPjFoPhW6/4Jo6b4NtdYnZJta134VadaafpyLG0jPLI9mFHCYAyCzFVHJAr9OaK8u/av/bE8CfsZfD2PXvGmpTC51CUWeh6Dp0Jvdc8VXzFVjsdOsk/e3VzI7ooRBgbtzlEDOOrD06kI2qT5n3sl+R8rnuYYDF1ozy/CrDxSs4qc53d3rebbWllZaaeZ/OB/wAHjFhceIv+Cs+l/wBn21xe/Yvh/pdvOYImkEUn2q+k2tgcHY6Nj0YHvRX7u/sq/sF2vj3w14k+Ifx+8D+GtQ+KfxU1yTxPqmlz+TqMfhKA29vaWWjxzqirL9ms7S3WWRcrJcG4dSUdTRXQeIfT/jfwNonxN8Ial4f8SaPpfiDQdYga1v8ATdStI7uzvoWGGjlikBR0I4KsCDX8hf8AwVj/AGgvHv7Kn7cXjjwZ8L/G/i/4b+D9L1GZLPQvC2sXGj6baL5h4jt7d0jQeyqKKKAPm3/h4h+0B/0XP4xf+FnqX/x6j/h4h+0B/wBFz+MX/hZ6l/8AHqKKAD/h4h+0B/0XP4xf+FnqX/x6j/h4h+0B/wBFz+MX/hZ6l/8AHqKKAD/h4h+0B/0XP4xf+FnqX/x6j/h4h+0B/wBFz+MX/hZ6l/8AHqKKAD/h4h+0B/0XP4xf+FnqX/x6j/h4h+0B/wBFz+MX/hZ6l/8AHqKKAD/h4h+0B/0XP4xf+FnqX/x6j/h4h+0B/wBFz+MX/hZ6l/8AHqKKAD/h4h+0B/0XP4xf+FnqX/x6j/h4h+0B/wBFz+MX/hZ6l/8AHqKKAD/h4h+0B/0XP4xf+FnqX/x6j/h4h+0B/wBFz+MX/hZ6l/8AHqKKAD/h4h+0B/0XP4xf+FnqX/x6j/h4h+0B/wBFz+MX/hZ6l/8AHqKKAD/h4h+0B/0XP4xf+FnqX/x6v6Pv+DVjwJofxB/ZCuPipr+jaVrnxPvLySxn8YahaR3OvT27KhaFr5wZ2jJVSVL4OBxxRRQB+rlFFFAH/9k=";

		var columns = [{
			width: 'auto',
			margin: [0, 0, 10, 0],
			stack: []
		},
		{
			width: 'auto',
			stack: []
		}];
		
		var cmyk = data.model.color.cmyk;

		var docDefinition = {
			info: {
				title: "Zamówienie " + id,
				author: "Perfecta - konfigurator"
			},
			pageMargins: [ 10, 10, 10, 10 ],
			content: [
				{ image: logoPerfectaBase64, fit: [100, 100], style: { alignment: "center" }},
				"\nKod Zamówienia: " + id,
				"\nZamawiajacy:",
				"Dane: " + data.orderForm.person.name,
				"Kontakt: " + data.orderForm.person.mail + ", " + data.orderForm.person.phone,
				data.orderOptions.delivery == "personal" ? "" : ("Adres: " + data.orderForm.person.street + ", " + data.orderForm.person.postalCode + " " + data.orderForm.person.city),
				!data.orderForm.invoiceNeeded ? "": "\nDane do faktury: \n Firma: " + data.orderForm.company.name + "\nNIP: " + data.orderForm.company.nip + "\nAdres: " + data.orderForm.company.street + ", " + data.orderForm.company.postalCode + " " + data.orderForm.company.city + ", " + data.orderForm.company.country,

				"\nParasol: " + data.model.title + " " + data.model.subtitle,
				"Kolor materiału: " + (!!data.model.color.paleteNo ? "nr. z palety " + data.model.color.paleteNo : "C: " + cmyk.C + ", M: " + cmyk.M + ", Y: " + cmyk.Y + ", K: " + cmyk.K),
				"Ilość: " + data.orderOptions.count,
				"Podstawa parasola: " + (!!data.orderOptions.base ? data.orderOptions.base.name : "bez podstaw parasola"),
				(!!data.orderOptions.base ? "Ilość podstaw: " + data.orderOptions.baseCount : ""),
				"Dostawa: " + (data.orderOptions.delivery == "personal" ? "Odbiór osobisty" : "Przesyłka kurierska"),

				"\nCena: " + prices.fullPrice + " NETTO " + "(" + prices.fullPriceVat + " BRUTTO)",
				"Dostawa: " + prices.delivery,

				"\nDane do przelewu:",
				"Perfecta Aleksander Szczebak,\nul. Mickiewicza 65, 51-684 Wroclaw",
				"Bank Zachodni WBK S.A.\n50 1090 2415 0000 0006 1200 7585\n\n",
				{ columns: columns },
				{
					text: "\n*Przedstawiona wizualizacja ma charakter pogladowy i nie moze byc traktowane jako ostateczny projekt realizacyjny, ze wzgledu na rozne kalibracje, kolory rzeczywiste oraz grafika moga sie roznic od tych widzianych na monitorze.",
					style: { fontSize: 9, aligment: "bottom" }
				}
			]
		};

		var screenshotCount = 0;
		$scope.$on("get-screenshot-result", function(event, imageUrl) {
			screenshotCount++;
			columns[screenshotCount % 2].stack.push(
				{ image: imageUrl, fit: [280, 280], margin: [0, 0, 0, 10] }
			);

			if (screenshotCount == 4 ) {
				docDefinition.content.push();
				pdfMake.createPdf(docDefinition).open();
			}
		});
		$scope.$broadcast("get-screenshot");
	}
}]);

app.directive("customize", function() {
	return {
		restrict: "E",
		scope: {},
		templateUrl: "customize/customize.html",
		controllerAs: "vm",
		controller: "customizeController"
	}
});

app.controller("customizeController", ["appService", "$state", "$scope", function(appService, $state, $scope) {
	if (!appService.getModel()) {
		$state.go("select-model");
	}

	var vm = this;
	appService.showWarning().take(1).subscribeOnNext(function() {
		$scope.$evalAsync(function() { 
			vm.showWarning = true;
		})
	});

	$(document).keyup(function(e) {
		if (e.originalEvent.keyCode === 13) {
			$scope.$evalAsync(function() { vm.showWarning = false; });
		}
		if (e.originalEvent.keyCode === 27) {
			$scope.$evalAsync(function() { vm.showWarning = false; });
		}
	});
}]);
app.directive("orderOptions", function() {
	return {
		restrict: "E",
		scope: {},
		templateUrl: "order-options/order-options.html",
		controllerAs: "vm",
		controller: "orderOptionsController"
	}
});

app.controller("orderOptionsController", ["$scope", "$state", "appService", function($scope, $state, appService) {
	if (!(this.model = appService.getModel())) {
		$state.go("select-model");
	}

	var vm = this;
	vm.deliveryOptions = {
		count: 1,
		baseCount: 1,
		base: null,
		delivery: "personal"
	}

	appService.orderOptions.take(1)
		.subscribeOnNext(deliveryOptions => {
			$scope.$evalAsync(function() { vm.deliveryOptions = deliveryOptions });
		});

	$scope.$watch("vm.deliveryOptions.count", function(newValue) {
		vm.deliveryOptions.count = Math.min(Math.max(1, newValue), 10);
	});

	$scope.$watch("vm.deliveryOptions.base", function(newValue) {
		if (!!newValue) {
			vm.deliveryOptions.baseCount = vm.deliveryOptions.baseCount || 1;
		} else {
			vm.deliveryOptions.baseCount = 0;
		}
	});


	$scope.$watch("vm.deliveryOptions.baseCount", function(newValue) {
		if (newValue < 1) {
			vm.deliveryOptions.base = null;
		}
		vm.deliveryOptions.baseCount = Math.min(Math.max(0, newValue), 10);
	});

	$scope.$watch("vm.deliveryOptions", function(newValue) {
		appService.orderOptions.onNext(newValue);
	}, true);
}]);
app.directive("orderForm", function() {
	return {
		restrict: "E",
		scope: {},
		templateUrl: "order-form/order-form.html",
		controllerAs: "vm",
		controller: "orderFormController"
	}
});

app.controller("orderFormController", ["$state", "$scope", "appService", "$element", function($state, $scope, appService, $element) {
	if (!appService.getModel()) {
		$state.go("select-model");
	}

	var vm = this;
	vm.orderForm = {
		invoice: false,
		additionalFiles: []
	};

	appService.orderOptions.take(1)
		.subscribeOnNext(function(orderOptions) { vm.orderOptions = orderOptions; });

	appService.orderForm.take(1)
		.subscribeOnNext(function(orderForm) { vm.orderForm = orderForm; });

	$scope.$watch("vm.orderForm", function(newValue) {
		appService.orderForm.onNext(newValue);
	}, true);

	this.deleteFile = function(index) {
		vm.orderForm.additionalFiles.splice(index, 1);
	}

	this.confirmOrder = function() {
		for (var errorArray in $scope.form.$error) {
			_.forEach($scope.form.$error[errorArray], function(formElement) {
				formElement.$setDirty();
			});
		}

		if ($scope.form.$valid) {
			$state.go("summary");
		}
	};
	
	$element.find("#additional-files").bind("change", function(changeEvent) {
		var files = $.extend({}, changeEvent.target.files);
		changeEvent.target.value = "";

		_.forEach(files, function(file) {
			var reader = new FileReader();
			reader.onload = function(readerEvent) {
				var base64 = readerEvent.target.result;
				$scope.$evalAsync(function() {
					vm.orderForm.additionalFiles.push({
						base64: base64,
						name: file.name
					})
				});
			};
			reader.readAsDataURL(file);
		});
	});
}]);
app.directive("preview", function() {
	return {
		restrict: "E",
		scope: {},
		templateUrl: "preview/preview.html",
		controllerAs: "vm",
		controller: "previewController"
	}
});

app.controller("previewController", ["$scope", "$state", "$stateParams", "$http", function($scope, $state, $stateParams, $http) {
	if (!$stateParams.id) {
		$state.go("select-model");
	}

	var vm = this;
	vm.id = $stateParams.id;
	var url = "http://dev.lithium.pl/perfecta/wp/wp-content/uploads/orders/" + vm.id + "/order.json";

	$http.get(url).then(
		function(response){
			$scope.$evalAsync(function() { vm.model = response.data; })
		},
		function(err){
			$scope.$evalAsync(function() { vm.notFound = true; })
		}
	);

	vm.downloadPdf = function() {
		var data = vm.model;
		var id = vm.id;
		var prices = vm.model.prices;

		var logoPerfectaBase64 = "data:image/jpeg;base64,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";

		var columns = [{
			width: 'auto',
			margin: [0, 0, 10, 0],
			stack: []
		},
		{
			width: 'auto',
			stack: []
		}];
		var cmyk = data.model.color.cmyk;
		var docDefinition = {
			info: {
				title: "Zamówienie " + id,
				author: "Perfecta - konfigurator"
			},
			pageMargins: [ 10, 10, 10, 10 ],
			content: [
				{ image: logoPerfectaBase64, fit: [100, 100], style: { alignment: "center" }},
				"\nKod Zamówienia: " + id,
				"\nZamawiajacy:",
				"Dane: " + data.orderForm.person.name,
				"Kontakt: " + data.orderForm.person.mail + ", " + data.orderForm.person.phone,
				data.orderOptions.delivery == "personal" ? "" : ("Adres: " + data.orderForm.person.street + ", " + data.orderForm.person.postalCode + " " + data.orderForm.person.city),
				!data.orderForm.invoiceNeeded ? "": "\nDane do faktury: \n Firma: " + data.orderForm.company.name + "\nNIP: " + data.orderForm.company.nip + "\nAdres: " + data.orderForm.company.street + ", " + data.orderForm.company.postalCode + " " + data.orderForm.company.city + ", " + data.orderForm.company.country,

				"\nParasol: " + data.model.title + " " + data.model.subtitle,
				"Kolor materiału: " + (!!data.model.color.paleteNo ? "nr. z palety " + data.model.color.paleteNo : "C: " + cmyk.C + ", M: " + cmyk.M + ", Y: " + cmyk.Y + ", K: " + cmyk.K),
				"Ilość: " + data.orderOptions.count,
				"Podstawa parasola: " + (!!data.orderOptions.base ? data.orderOptions.base.name : "bez podstaw parasola"),
				(!!data.orderOptions.base ? "Ilość podstaw: " + data.orderOptions.baseCount : ""),
				"Dostawa: " + (data.orderOptions.delivery == "personal" ? "Odbiór osobisty" : "Przesyłka kurierska"),

				"\nCena: " + prices.netto + " NETTO " + "(" + prices.brutto + " BRUTTO)",
				"Dostawa: " + prices.delivery,

				"\nDane do przelewu:",
				"Perfecta Aleksander Szczebak,\nul. Mickiewicza 65, 51-684 Wroclaw",
				"Bank Zachodni WBK S.A.\n50 1090 2415 0000 0006 1200 7585\n\n",
				{ columns: columns },
				{
					text: "\n*Przedstawiona wizualizacja ma charakter pogladowy i nie moze byc traktowane jako ostateczny projekt realizacyjny, ze wzgledu na rozne kalibracje, kolory rzeczywiste oraz grafika moga sie roznic od tych widzianych na monitorze.",
					style: { fontSize: 9, aligment: "bottom" }
				}
			]
		};

		var screenshotCount = 0;
		$scope.$on("get-screenshot-result", function(event, imageUrl) {
			screenshotCount++;
			columns[screenshotCount % 2].stack.push(
				{ image: imageUrl, fit: [280, 280], margin: [0, 0, 0, 10] }
			);

			if (screenshotCount == 4 ) {
				docDefinition.content.push();
				pdfMake.createPdf(docDefinition).open();
			}
		});
		$scope.$broadcast("get-screenshot");
	}
}]);
app.directive("price", function() {
	return {
		restrict: "E",
		scope: {},
		templateUrl: "price/price.html",
		controllerAs: "vm",
		controller: "priceController"
	}
});

app.controller("priceController", ["$rootScope", "$scope", "appService", "priceService", "$element", function($rootScope, $scope, appService, priceService, $element) {
	var selectedModel, orderOptions, gotImages = false, customColor = false, discount = 0;
	var vm = this;
	vm.price = 0;

	$rootScope.$on("model-selected", function(event, model) {
		selectedModel = model;
		count();
	});

	$rootScope.$on("decal-image-added", function(event) {
		gotImages = true;
		count();
	});

	$rootScope.$on("decal-image-removed", function(event) {
		var images = appService.getImages();

		if ($.isEmptyObject(images)) {
			gotImages = false;
			count();
		}
	});

	$rootScope.$on("model-color-changed", function(event, color) {
		customColor = !color.paleteNo;
		count();
	});

	$rootScope.$on("discount-added", function(event, value) {
		discount = value;
		priceService.setDiscount(discount);
		count();
	});

	appService.orderOptions.subscribeOnNext(function(options) {
		orderOptions = options;
		count();
	});

	function count() {
		var price = 0;

		if (!!selectedModel) {
			var count = !!orderOptions ? orderOptions.count : 1;
			var orderTier = !!orderOptions && orderOptions.count > 2 ? 1 : 0;

			price = selectedModel.price.base[orderTier];

			if (gotImages || customColor) { // zwiększ cene za zadruk
				price += price * selectedModel.price.print[orderTier];
			}

			priceService.setModelPrice(price);

			price = price * count; // zwiększ cene za ilość

			if (!!orderOptions && !!orderOptions.base) { // dodaj cenę za podstawę
				price += orderOptions.base.price * orderOptions.baseCount;
			}
			
			price -= price * discount;

			var delivery = 0;

			if (!!orderOptions && orderOptions.delivery == "poland") { // dodaj cenę za dostawę
				delivery = selectedModel.price.delivery[orderTier];
				price += delivery;
			}
		}

		priceService.setDeliveryPrice(delivery);
		priceService.setFullPrice(price);
		$scope.$evalAsync(function() {
			if (vm.price != price) {
				vm.price = price;
				vm.animate();
			}
		});
	}

	this.animate = function() {
		var elem = $element.find("span:last-of-type");
		elem.addClass("bounce");
		setTimeout(function() {
			elem.removeClass("bounce");
		}, 550);
	}
}]);
app.factory("priceService", function() {
	var modelPrice = 0;
	var fullPrice = 0;
	var deliveryPrice = 0;
	var discount = 0;

	return {
		getModelPrice() { return modelPrice; },
		getFullPrice(modificator) { return fullPrice * modificator; },
		getDeliveryPrice() { return deliveryPrice; },
		setModelPrice(price) { modelPrice = price; },
		setFullPrice(price) { fullPrice = price; },
		setDeliveryPrice(price) { deliveryPrice = price; },
		setDiscount(d) { discount = d; },
		getDiscount() { return discount; }
	}
});
app.directive("selectModel", function() {
	return {
		restrict: "E",
		scope: {},
		templateUrl: "select-model/select-model.html",
		controllerAs: "vm",
		controller: "selectModelController"
	}
});

app.controller("selectModelController", ["$rootScope", "$scope", "appService", "$state", function($rootScope, $scope, appService, $state) {
	var vm = this;

	vm.appService = appService;
	
	appService.getModels().then(function(result) {
		$scope.$evalAsync(function() { vm.models = result.data; })
	});

	$(document).keyup(function(e) {		
		if (e.originalEvent.keyCode === 13) {
			vm.appService.setModel(vm.selectedModel);
			$state.go("customize");
		}
		if (e.originalEvent.keyCode === 27) {
			$scope.$evalAsync(function() {
				vm.selectedModel = null
			});
		}
	});

	vm.goToPreview = function() {
		if (!vm.previewId) return;

		$state.go("preview", { id: vm.previewId });
	}
}]);
app.directive("summary", function() {
	return {
		restrict: "E",
		scope: {},
		templateUrl: "summary/summary.html",
		controllerAs: "vm",
		controller: "summaryController"
	}
});

app.controller("summaryController", ["$rootScope", "$scope", "$state", "appService", "priceService", "$http", function($rootScope, $scope, $state, appService, priceService, $http) {
	if (!(this.model = appService.getModel())) {
		$state.go("select-model");
	}

	var vm = this;
	vm.priceService = priceService;
	vm.images = appService.getImages();

	appService.orderForm.take(1)
		.subscribeOnNext(function(orderForm) {
			vm.orderForm = orderForm;
			vm.imagesIsEmpty = _.isEmpty(vm.images) && _.isEmpty(vm.orderForm.additionalFiles);
		});

	appService.orderOptions.take(1)
		.subscribeOnNext(function(orderOptions) { vm.orderOptions = orderOptions; });

	vm.submitOrder = function() {
		if (!vm.acceptRules) return;

		var discountPrice = priceService.getFullPrice(1).toFixed(2);
		var discountPriceBrutto = priceService.getFullPrice(1.23).toFixed(2);
		var discount = 1 - priceService.getDiscount()
		
		var submitModel = {
			model: vm.model,
			orderForm: vm.orderForm,
			orderOptions: vm.orderOptions,
			prices: {
				total: parseFloat(discountPrice / discount).toFixed(2),
				discount: priceService.getDiscount(),
				netto: discountPrice,
				brutto: discountPriceBrutto,
				delivery: priceService.getDeliveryPrice(),
			},
			images: []
		};

		var prices = {
			delivery: priceService.getDeliveryPrice(),
			fullPrice: priceService.getFullPrice(1).toFixed(2),
			fullPriceVat: priceService.getFullPrice(1.23).toFixed(2)
		}

		_.forEach(vm.images, function(image) {
			image.decal = _.omit(image.decal, ["items", "material"]);
			submitModel.images.push(image);
		});

		$state.go("confirmation", { submitModel: submitModel, previewId: "#mock-id", prices: prices });
		return;

		var req = {
			method: 'POST',
			url: 'http://dev.lithium.pl/perfecta/wp/wp-admin/admin-ajax.php',
			data: $.param({
				action: "createOrder",
				order: submitModel
			}),
			headers: {'Content-Type': 'application/x-www-form-urlencoded'}
		}

		vm.sendingRequest = true;
		$http(req).then(function(response) {
			console.log("Kod:" + response.data.guild);

			$state.go("confirmation", {
				submitModel: submitModel,
				previewId: response.data.guild,
				prices: prices
			});
		}, function(err){
			alert("Coś poszło nie tak");
			console.log(err);
			$scope.$evalAsync(function() { vm.sendingRequest = false; });
		});
	}

	vm.submitDiscount = function() {
		if (!vm.discountCode) return;

		var req = {
			method: 'POST',
			url: 'http://dev.lithium.pl/perfecta/wp/wp-admin/admin-ajax.php',
			data: $.param({
				action: "getDiscount",
				discount: vm.discountCode
			}),
			headers: {'Content-Type': 'application/x-www-form-urlencoded'}
		}

		$http(req).then(
			function(response){
				$scope.$evalAsync(function() {
					vm.discountResult = response.data;
					$rootScope.$broadcast("discount-added", vm.discountResult);
					vm.discountCode = "";
				});
			},
			function(err){
				$scope.$evalAsync(function() {
					vm.discountResult = false;
					$rootScope.$broadcast("discount-added", 0);
				})
				console.log(err);
			}
		);
	}
}])

app.directive("ngClickAnimate", ['$animate', function($animate) {
	return {
		link: function (scope, element, attrs) {
			element.on('click', function() {
				var self = angular.element(this);
				if (self.hasClass("disable-ng-click"))
					return;

				$animate.addClass(self, "ng-click").then(function() {
					self.removeClass("ng-click");
				});
			});
		}
	};
}]);
app.directive("viewOrder", function() {
	return {
		restrict: "E",
		scope: {},
		templateUrl: "view-order/view-order.html",
		controllerAs: "vm",
		controller: "viewOrderController"
	}
});

app.controller("viewOrderController", ["$scope", "$http", function($scope, $http) {
	var vm = this;
	$scope.vm.orderGuid = "579a01d9f37f8";
	$scope.vm.orderJso = "";
	
	var url = "http://dev.lithium.pl/perfecta/wp/wp-content/uploads/orders/" + $scope.vm.orderGuid + "/order.json";

	$http.get(url).then(function(response){
		$scope.vm.orderJson = response.data;
		console.log(response.data);
	}, function(err){
		alert("error");
		console.log(err);
	});
	

	var discountId = "XXX-ZZ";
	$scope.vm.discount = -1;

	var req = {
		method: 'POST',
		url: 'http://dev.lithium.pl/perfecta/wp/wp-admin/admin-ajax.php',
		data: $.param({
			action: "getDiscount",
			discount: discountId
		}),
		headers: {'Content-Type': 'application/x-www-form-urlencoded'}
	}

	$http(req).then(function(response){
		$scope.vm.discount = response.data;
		console.log(response);
	}, function(err){
		alert("error");
		console.log(err);
	});

}]);
function ConfiguratorEngine($model, $q, $element, $scope) {
	var mainMesh, scene, renderer, camera, controls = {}, images = {}, selectedImage, raycaster, textureLoader, mouse, mouseHelper;
	var zoom = 0;

	this.isCameraEnabled = function() { return controls.enableRotate; }
	this.toggleCamera = function(enable) {
		controls.enableRotate = enable != undefined ? enable : !controls.enableRotate;
	}
	
	this.getCameraZoom = function() { return zoom; }
	this.zoomCamera = function(delta) {
		zoom = Math.max(0, Math.min(zoom + delta, 100));
		var distanceDelta = controls.maxDistance - controls.minDistance;
		controls.distance = controls.minDistance + distanceDelta * (100 - zoom) / 100;
		controls.update();
	}

	this.changeColor = function(color) {
		var colorInt = parseInt('0x' + color);
		mainMesh.traverse(function(child) {
			if (child instanceof THREE.Mesh) {
				child.material.color.setHex(colorInt);
			}
		});
	}

	this.addImage = function(image) {
		images[image.id] = image;
		initializeImage(image);
	}

	this.selectImage = function(image) { selectedImage = image; }
	
	this.updateImage = function(image) {
		if (!!image.decal.origin) {
			updateImageDecals(image);
		}
	}

	this.removeImage = function(image) {
		if (!!image.decal.material) {
			image.decal.material.dispose();
		}
		_.forEach(image.decal.items, function(decal) { scene.remove(decal); });
	}

	this.getScreenshot = function(phi, theta) {
		var oldDistance = controls.distance;
		var oldSpherical = $.extend({}, controls.spherical);
		var oldWidth = $element[0].offsetWidth;
		var oldHeight = $element[0].offsetHeight;

		// set canvas for screenshot
		this.zoomCamera(-100);
		this.zoomCamera(50);
		renderer.setSize(280 * 4, 200 * 4);
		controls.setPhi(1000);
		controls.setPhi(phi);
		controls.setTheta(theta);
		controls.update();
		renderer.render(scene, camera);

		var dataUrl = renderer.domElement.toDataURL();

		// revert changes
		renderer.setSize(oldWidth, oldHeight);
		controls.distance = oldDistance;
		controls.spherical = oldSpherical;
		controls.update();
		renderer.render(scene, camera);

		return dataUrl;
	}

	this.init = function() {
		var defer = $q.defer();
		scene = new THREE.Scene();

		// etc
		raycaster = new THREE.Raycaster();
		textureLoader = new THREE.TextureLoader();
		mouse = new THREE.Vector2();
		mouseHelper = new THREE.Mesh(new THREE.BoxGeometry(1, 1, 10), new THREE.MeshNormalMaterial());

		loadModel().then(function() {
			// camera
			camera = new THREE.PerspectiveCamera(45, $element[0].offsetWidth / $element[0].offsetHeight, 1, 1000);
			camera.position.z = 500;

			// renderer
			renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, preserveDrawingBuffer: true });
			renderer.setClearColor(0xf3f3f3);
			renderer.setPixelRatio(window.devicePixelRatio);
			renderer.setSize($element[0].offsetWidth, $element[0].offsetHeight);
			$element[0].appendChild(renderer.domElement);

			// lights
			var directionalLight = new THREE.DirectionalLight(0xffffff, 0.15);
			directionalLight.position.set(250, 500, 500);
			directionalLight.target.position.set(0, 0, 0);
			scene.add(directionalLight);
			directionalLight = new THREE.DirectionalLight(0xffffff, 0.15);
			directionalLight.position.set(500, 500, -250);
			directionalLight.target.position.set(0, 0, 0);
			scene.add(directionalLight);
			directionalLight = new THREE.DirectionalLight(0xffffff, 0.1);
			directionalLight.position.set(-250, 500, 0);
			directionalLight.target.position.set(0, 0, 0);
			scene.add(directionalLight);
			scene.add(new THREE.AmbientLight(0x404040, 2.5));

			// controls
			controls = new THREE.OrbitControls(camera, renderer.domElement);
			controls.setPhi(-45);
			controls.setTheta(70);
			controls.update();

			// TODO: dodać dispose
			(function render() {
				renderer.render(scene, camera);
				requestAnimationFrame(render);
			})();

			initUserEvents();

			defer.resolve();
		});

		return defer.promise;
	}

	function updateImageDecals(image) {
		var decalRepeat = getModelRepeat(image);
		var angleStep = 360 / decalRepeat * (Math.PI / 180);
		var scale = new THREE.Vector3(image.decal.scale * image.aspectRatio, image.decal.scale, image.decal.scale);
		var origin = threeOriginFromSimpleObj(image.decal.origin);
		origin.rotation.z -= image.decal.rotation * (Math.PI / 180);
		var geometry = new THREE.DecalGeometry(mainMesh, origin.point, origin.rotation, scale);
		var mesh = new THREE.Mesh(geometry, image.decal.material);

		_.forEach(image.decal.items, function(decal) { scene.remove(decal); });
		image.decal.items = [];
		
		for (var i = 0; i < decalRepeat; i++) {
			var decal = mesh.clone();
			decal.rotateOnAxis(new THREE.Vector3(0, 1, 0), angleStep * i);
			image.decal.items.push(decal);
			scene.add(decal);
		}

		$scope.$evalAsync(function() {});
	}

	function checkCollision() {
		if (controls.enableRotate)
			return null;
		
		raycaster.setFromCamera(mouse, camera);
		var intersects = raycaster.intersectObjects([mainMesh])[0];

		if (intersects) {
			var point = intersects.point;
			var normal = intersects.face.normal.clone();
			normal.add(point);

			mouseHelper.position.copy(point);
			mouseHelper.lookAt(normal);

			var origin = {
				point: point.clone(),
				normal: normal.clone(),
				rotation: mouseHelper.rotation.clone()
			}

			return simplifyOrigin(origin);
		}

		return null;
	}

	// ↓ Boring stuff below this line ↓

	function initializeImage(image) {
		if (!image.decal) {
			image.decal = {};
			image.decal.scale = !!image.textData ? 5 : 20;
			image.decal.rotation = 0;
		}

		image.decal.material = new THREE.MeshPhongMaterial({
			specular: 0x444444,
			normalScale: new THREE.Vector2(1, 1),
			shininess: 30,
			transparent: true,
			depthTest: true,
			depthWrite: false,
			polygonOffset: true,
			polygonOffsetFactor: -4,
			wireframe: false
		});
		
		var tex = textureLoader.load(image.url);
		tex.magFilter = THREE.LinearFilter;
		tex.anisotropy = 16;

		image.decal.material.map = tex;

		if (!!image.decal.origin) {
			updateImageDecals(image);
		}
	}

	function getModelRepeat(image) {
		if (image.repetition === "all")
			return $model.tiles;

		if (image.repetition === "half")
			return $model.tiles / 2;
		
		return 1;
	}

	function loadModel() {
		var loader = new THREE.JSONLoader();
		var modelPromise = $q.defer();
		var modelPartLoaded = new Rx.Subject();

		loader.load($model.model3d.top,
			function(geometry, materials) {
				var material = new THREE.MeshPhongMaterial({ specular: 0x111111 });
				mainMesh = new THREE.Mesh(geometry, material);
				mainMesh.position.y = -50;
				scene.add(mainMesh);
				modelPartLoaded.onNext();
			});

		loader.load($model.model3d.bot,
			function(geometry, materials) {
				var material = new THREE.MeshLambertMaterial({ color: 0xffffff });
				var mesh = new THREE.Mesh(geometry, material);
				mesh.position.y = -50;
				scene.add(mesh);
				modelPartLoaded.onNext();
			});

		modelPartLoaded.skip(1).take(1)
			.subscribeOnNext(function() {
				modelPromise.resolve();
			})

		return modelPromise.promise;
	}

	// Events ↓

	function initUserEvents() {
		renderer.domElement.addEventListener("mousedown", onMouseDown);
		renderer.domElement.addEventListener("mouseup", onMouseUp);
		renderer.domElement.addEventListener("mousemove", onTouchMove);
		renderer.domElement.addEventListener("touchmove", onTouchMove);
		window.addEventListener("resize", function() {
			camera.aspect = $element[0].offsetWidth /  $element[0].offsetHeight;
			camera.updateProjectionMatrix();
			renderer.setSize($element[0].offsetWidth, $element[0].offsetHeight);
		}, false);
	}

	function onMouseDown(event) {
		if (!selectedImage || !!controls.enableRotate)
			return;

		controls.enabled = false;
		onTouchMove(event);
	}

	function onMouseUp() { controls.enabled = true; }

	function onTouchMove(event) {
		if (controls.enabled)
			return;
		
		var x, y;

		if (event.changedTouches) {
			x = event.changedTouches[0].pageX;
			y = event.changedTouches[0].pageY;
		} else {
			x = event.offsetX;
			y = event.offsetY;
		}

		mouse.x = (x / $element[0].offsetWidth) * 2 - 1;
		mouse.y = - (y / $element[0].offsetHeight) * 2 + 1;

		var collision = checkCollision();
		if (!!collision && !controls.enabled) {
			selectedImage.decal.origin = collision;
			updateImageDecals(selectedImage);
		}
	}

	function simplifyOrigin(origin) {
		return {
			point: simplifyVector3(origin.point),
			normal: simplifyVector3(origin.normal),
			rotation: simplifyVector3(origin.rotation),
		}
	}

	function simplifyVector3(vector) {
		return { x: vector.x, y: vector.y, z: vector.z }
	}

	function threeVector3FromSimpleObj(vectorSimple) {
		return new THREE.Vector3(vectorSimple.x, vectorSimple.y, vectorSimple.z);
	}

	function threeOriginFromSimpleObj(originSimple) {
		return {
			point: threeVector3FromSimpleObj(originSimple.point),
			normal: threeVector3FromSimpleObj(originSimple.normal),
			rotation: threeVector3FromSimpleObj(originSimple.rotation),
		}
	}
}
app.directive("configurator", function() {
	return {
		restrict: "E",
		scope: { preview: "=" },
		templateUrl: "customize/configurator/configurator.html",
		controllerAs: "vm",
		controller: "configuratorController"
	};
})

app.controller("configuratorController", ["$scope", "$element", "appService", "$q", "$rootScope", function($scope, $element, appService, $q, $rootScope) {
	var vm = this;
	var model = this.model = !!$scope.preview ? $scope.preview.model : appService.getModel();
	vm.images = [];
	if (!model) return;

	vm.engine = engine = new ConfiguratorEngine(model, $q, $element, $scope);
	engine.init().then(function() {
		$element.addClass("ready");
		$scope.$evalAsync(function() { vm.isInitialized = true; })
		hookEvents();

		var images = !!$scope.preview ? $scope.preview.images : appService.getImages();

		for (var key in images) {
			engine.addImage(images[key]);
		}
		
		if (!!model.color) {
			engine.changeColor(model.color.color);
		}
	});

	function hookEvents() {
		$element.on("mousewheel DOMMouseScroll", function(event) {
			console.log(event);
			var wheelDelta = !!event.originalEvent.detail ? -event.originalEvent.detail : event.originalEvent.wheelDelta;
			var delta = wheelDelta >= 0 ? 10 : -10;
			$scope.$evalAsync(function() { engine.zoomCamera(delta); });
		});

		window.addEventListener("keydown", function(event) {
			if (event.keyCode == 32 && !$("input").is(":focus")) {
				$scope.$evalAsync(function() { engine.toggleCamera(); });
			}
		});
	}

	$scope.$on("model-color-changed", function(event, color) { 
		model.color = color;
		engine.changeColor(color.color);
	});
	$scope.$on("decal-image-added", function(event, image) {
		engine.addImage(image);
		vm.images.push(image);
	});
	$scope.$on("decal-image-changed", function(event, image) { engine.updateImage(image); });
	$scope.$on("decal-image-removed", function(event, image) {
		engine.removeImage(image);
		_.remove(vm.images, image);
	});
	$scope.$on("decal-image-selected", function(event, image) { 
		$scope.$evalAsync(function() { 
			engine.toggleCamera(false);
			vm.selectedImage = image;

			if (!!image) {
				imagePropeller.angle = image.decal.rotation;
			}
		});
		engine.selectImage(image);
	});

	imagePropeller = new Propeller($(".rotate-with-mouse"), { interia: 0, speed: 0, step: 1,
		onRotate: function() {
			vm.selectedImage.decal.rotation = this.angle;
			engine.updateImage(vm.selectedImage);
		}
	});

	vm.changeImageScale = function(delta) {
		vm.selectedImage.decal.scale += 2 * delta;
		if (vm.selectedImage.decal.scale < 2)
			vm.selectedImage.decal.scale = 2;

		engine.updateImage(vm.selectedImage);
	}

	// For PDF
	$scope.$on("get-screenshot", function(event, color) {
		$rootScope.$broadcast("get-screenshot-result", engine.getScreenshot(-90, 90));
		$rootScope.$broadcast("get-screenshot-result", engine.getScreenshot(-90, 180));
		$rootScope.$broadcast("get-screenshot-result", engine.getScreenshot(-90, 270));
		$rootScope.$broadcast("get-screenshot-result", engine.getScreenshot(-90, 360));
	});


	// TODO: dispose
	/*$scope.$on("$destroy", function() {
		vm.cancelRendering = true;

		_.forEach(vm.scene.children, function(children) { vm.scene.remove(children); });
		vm.renderer.dispose();
		vm.controls.dispose();

		_.forEach(vm.$disposables, function(disposable) { disposable.dispose(); });
	});*/
}]);
app.directive("configuratorOptions", function() {
	return {
		restrict: "E",
		scope: {},
		templateUrl: "customize/configurator-options/configurator-options.html",
		controllerAs: "vm",
		controller: "configuratorOptionsController"
	}
});

app.controller("configuratorOptionsController", function() {
	this.selectedMenu = "images";
});
app.directive("colorOptions", function() {
	return {
		restrict: "E",
		scope: {},
		templateUrl: "customize/configurator-options/color-options/color-options.html",
		controllerAs: "vm",
		controller: "colorOptionsController"
	};
});

app.controller("colorOptionsController", ["$rootScope", "$scope", "appService", function ($rootScope, $scope, appService) {
	var vm = this;
	vm.customCMYK = { C: 0, M: 0, Y: 0, K: 0 };

	vm.resetCmyk = function() { vm.customCMYK = { C: 0, M: 0, Y: 0, K: 0 } }

	// TODO: może by tak to pobierać z WP?
	vm.defaultColors = [
		{ color: "FFFFFF", paleteNo: "9001" },
		{ color: "FFFFCC", paleteNo: "9002" },
		{ color: "FBBE02", paleteNo: "9005" },
		{ color: "065019", paleteNo: "9006" },
		{ color: "18183A", paleteNo: "9007" },
		{ color: "D00204", paleteNo: "9008" },
		{ color: "672831", paleteNo: "9009" },
		{ color: "183022", paleteNo: "9010" },
		{ color: "F1E5B1", paleteNo: "9011" },
		{ color: "BA996C", paleteNo: "9012" },
		{ color: "8F948E", paleteNo: "9013" },
		{ color: "5E5751", paleteNo: "9014" },
		{ color: "59543E", paleteNo: "9015" }
	];
	vm.selectColor = function(color) {
		vm.selectedColor = color;
		if (!!color.paleteNo) {
			vm.resetCmyk()
		} else {
			appService.showWarning().onNext();
		}
		
		$rootScope.$broadcast("model-color-changed", color);
	}

	vm.onCmykSlide = function() {
		vm.customCMYK.C = Math.min(vm.customCMYK.C, 100) || 0;
		vm.customCMYK.M = Math.min(vm.customCMYK.M, 100) || 0;
		vm.customCMYK.Y = Math.min(vm.customCMYK.Y, 100) || 0;
		vm.customCMYK.K = Math.min(vm.customCMYK.K, 100) || 0;

		c = vm.customCMYK.C / 100;
		m = vm.customCMYK.M / 100;
		y = vm.customCMYK.Y / 100;
		k = vm.customCMYK.K / 100;

		var r = 1 - Math.min( 1, c * ( 1 - k ) + k );
		var g = 1 - Math.min( 1, m * ( 1 - k ) + k );
		var b = 1 - Math.min( 1, y * ( 1 - k ) + k );

		r = Math.round( r * 255 );
		g = Math.round( g * 255 );
		b = Math.round( b * 255 );

		var hexColor = ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
		vm.selectColor({ color: hexColor, paleteNo: null, cmyk: vm.customCMYK });
	}

	
	vm.resetCmyk();
}]);
app.directive("saveOptions", function () {
	return {
		restrict: "E",
		scope: {},
		templateUrl: "customize/configurator-options/save-options/save-options.html",
		controller: ["$scope", "customizeService", function($scope, customizeService) {
			$scope.downloadConfig = function() {
				var canvas = $("configurator canvas").get(0);
				var imgData = canvas.toDataURL("image/jpeg", 1.0);
				var pdf = new jsPDF();
				pdf.setFontSize(40);
				pdf.text(35, 25, "Perfekta - konfigurator");
				pdf.addImage(imgData, 'JPEG', 15, 40, 180, 180);
				pdf.save("parasol.pdf");
			}
		}]
	}
});
app.directive("imagesOptions", function () {
	return {
		restrict: "E",
		scope: {},
		templateUrl: "customize/configurator-options/images-options/images-options.html",
		controllerAs: "vm",
		controller: "imagesOptionsController",
		link: function(scope, element, attrs, ctrl) {
			ctrl.handleFileInput();
		}
	}
});

app.controller("imagesOptionsController", ["$rootScope", "$scope", "$element", "appService", function($rootScope, $scope, $element, appService) {
	var vm = this;
	vm.images = appService.getImages();
	vm.selectedImage = null;

	vm.selectImage = function(image) {
		vm.selectedImage = image;
		$rootScope.$broadcast("decal-image-selected", image);
	}

	vm.removeImage = function(image) {
		delete vm.images[image.id];
		if (vm.selectedImage === image) {
			var img = vm.images[Object.keys(vm.images)[Object.keys(vm.images).length - 1]]; // get last image
			vm.selectImage(img);
		}
		$rootScope.$broadcast("decal-image-removed", image);
	}

	vm.changeSelectedImageRepetition = function(repetition) {
		vm.selectedImage.repetition = repetition;
		$rootScope.$broadcast("decal-image-changed", vm.selectedImage);
	}

	this.handleFileInput = function() {
		$element.find("#file-select").bind("change", function(changeEvent) {
			appService.showWarning().onNext();
			var files = $.extend({}, changeEvent.target.files);
			changeEvent.target.value = "";

			_.forEach(files, function(file) {
				var reader = new FileReader();
				reader.onload = FileReaderOnLoad;
				reader.readAsDataURL(file);
			})

			function FileReaderOnLoad(readerEvent) {
				var base64Image = readerEvent.target.result;
				var img = new Image();

				img.onload = function() {
					var model = {
						id: "image #" + _.uniqueId(),
						url: base64Image,
						repetition: "once",
						aspectRatio: img.width / img.height
					}

					$scope.$evalAsync(function() { vm.images[model.id] = model; });
					$rootScope.$broadcast("decal-image-added", model);
					vm.selectImage(model);
				}

				img.src = base64Image;
			};
		});
	}
}]);
app.directive("textOptions", function () {
	return {
		restrict: "E",
		scope: {},
		templateUrl: "customize/configurator-options/text-options/text-options.html",
		controllerAs: "vm",
		controller: "textOptionsController"
	}
});

app.controller("textOptionsController", ["$rootScope", "$scope", "$element", function($rootScope, $scope, $element) {
	var vm = this;
	var domTextHolder = $element.find("#dom-text-holder");

	vm.inputModel = "";
	vm.isModelEmpty = true;
	vm.texts = {};
	vm.selectedText = null;

	vm.textColorsStack = ["#000000","#FFFFFF","#7F7F7F","#C3C3C3","#880015","#B97A57","#ED1C24","#FFAEC9","#FF7F27","#FFC90E","#FFF200","#EFE4B0","#22B14C","#B5E61D","#00A2E8","#99D9EA","#3F48CC","#7092BE","#A349A4","#C8BFE7"];
	vm.textColor = "#000000";
	vm.fontFamily = "Arial";

	vm.removeText = function(text) {
		delete vm.texts[text.id];
		if (vm.selectedText === text) {
			vm.selectedText = vm.texts[Object.keys(vm.texts)[Object.keys(vm.texts).length - 1]]; // get last text
		}

		vm.isModelEmpty = Object.keys(vm.texts).length === 0;
		$rootScope.$broadcast("decal-image-removed", text);
	}

	vm.selectText = function(text) {
		vm.selectedText = text;
		$rootScope.$broadcast("decal-image-selected", text);
	}

	vm.changeSelectedTextRepetition = function(repetition) {
		vm.selectedText.repetition = repetition;
		$rootScope.$broadcast("decal-image-changed", vm.selectedText);
	}

	vm.addText = function(event) {
		if (!!event && event.keyCode != 13)
			return;

		var ctx = document.getElementById("text-canvas").getContext("2d");
		ctx.font = "100px " + vm.fontFamily;
		ctx.canvas.width = ctx.measureText(vm.inputModel).width;
		ctx.canvas.height = 120;
		ctx.translate(0.5, 0.5);
		ctx.imageSmoothingEnabled = true;
		ctx.font = "100px " + vm.fontFamily;
		ctx.fillStyle = vm.textColor;
		ctx.fillText(vm.inputModel, 0, 95);
		var dataUrl = ctx.canvas.toDataURL();

		var img = new Image();

		img.onload = function() {
			var model = {
				id: "text #" + _.uniqueId(),
				url: dataUrl,
				repetition: "once",
				aspectRatio: img.width / img.height,
				textData: {
					fontFamily: vm.fontFamily,
					fontSize: vm.fontSize,
					color: vm.textColor,
					text: vm.inputModel
				}
			}

			$scope.$evalAsync(function() {
				vm.texts[model.id] = model;
				vm.isModelEmpty = false;
				vm.inputModel = "" 
			});
			$rootScope.$broadcast("decal-image-added", model);
			vm.selectText(model);
		};

		img.src = dataUrl;

		return;
	}
}]);